VEEN v0.0.1++ — Kubernetes-Native Profile (Tightened)
	0.	Purpose

This document refines the VEEN v0.0.1 Kubernetes-native profile to an implementation-grade level.

The goal is to make a “VEEN network” a portable, disposable unit that can be:
	•	created by applying a small set of Kubernetes manifests
	•	destroyed by deleting a namespace
	•	self-tested via standard Jobs
	•	wired into other workloads using stable Service endpoints

Protocol semantics (wire, overlay, identity, capability, revocation, wallet) are unchanged.
Only deployment, lifecycle, and operational invariants are specified more tightly.
	1.	Scope and non-goals

1.1 In scope
	•	Mapping VEEN authority and tenant hubs to Kubernetes resources.
	•	Mapping VEEN bridges to Kubernetes resources.
	•	Packaging VEEN CLI and self-tests as Jobs.
	•	Naming, labels, annotations, and minimal RBAC.
	•	Health probes, readiness conditions, and metrics exposure.
	•	Storage layout for hub state and attachments in a cluster.

1.2 Out of scope
	•	Cluster provisioning (nodes, CNI, ingress controllers).
	•	TLS termination and identity at the Kubernetes ingress layer.
	•	Multi-cluster mesh or global control planes.
	•	Any protocol-level change to VEEN messages or schemas.

	2.	Logical model of a VEEN network in Kubernetes

2.1 Definitions
	•	VEEN universe
	•	A set of hubs that share the same authority hub and schema universe.
	•	Authority hub
	•	The root of trust for schemas, label classes, authorities, and revocation streams.
	•	Tenant hub
	•	Hub instance bound to a tenant, environment, or application.
	•	VEEN network (Kubernetes sense)
	•	A namespace plus all VEEN objects inside it that share a single tenant hub and its bridge connections.

2.2 Mapping
	•	One VEEN universe per cluster (in v0.0.1++).
	•	Exactly one authority hub per VEEN universe.
	•	Zero or more tenant hubs, each in its own namespace.
	•	Zero or more bridges linking authority → tenant and tenant ↔ tenant.

	3.	Resource naming, labels, and annotations

3.1 Namespaces

Namespace patterns:
	•	Authority namespace
	•	Name: veen-system
	•	Tenant namespaces
	•	Name: veen-tenant-<tenant-id>
	•	<tenant-id> SHOULD be a short, DNS-safe identifier:
	•	lowercase letters, digits, hyphen
	•	for example acme-prod, team1-dev

3.2 Labels

Every VEEN-managed Pod, Deployment, StatefulSet, Job, and Service MUST include:
	•	app.kubernetes.io/part-of=veen
	•	app.kubernetes.io/component=hub|bridge|cli|selftest
	•	veen.io/role=authority|tenant|bridge|selftest
	•	veen.io/universe-id=<universe-id>
	•	A short identifier like default, stage-1.
	•	veen.io/tenant-id=<tenant-id>
	•	Present only for tenant hubs, bridges tied to a tenant, and per-tenant selftests.

3.3 Annotations

Recommended annotations:
	•	veen.io/profile=authority|tenant|bridge|cli|selftest
	•	veen.io/version=<semantic-version>
	•	Matches image tag or protocol version.
	•	veen.io/config-hash=<opaque-hash>
	•	Optional: hash of main config to make drift detection easier.

	4.	Authority hub specification

4.1 Resource set

Authority hub MUST be represented by:
	•	StatefulSet: veen-authority-hub
	•	Service: veen-authority
	•	ConfigMap: veen-authority-config
	•	Secret: veen-authority-keys
	•	PersistentVolumeClaim: veen-authority-data

All in namespace veen-system.

4.2 StatefulSet behaviour
	•	Replicas: 1
	•	Pod template:
	•	Container image:
	•	veen-hub:<version>
	•	Command:
	•	veen-hub
	•	Arguments:
	•	--profile=authority
	•	--config=/etc/veen/hub.yaml
	•	--data-dir=/var/lib/veen
	•	Environment variables (minimum):
	•	VEEN_ROLE=authority
	•	VEEN_UNIVERSE_ID=<universe-id>
	•	VEEN_LOG_LEVEL=info (default)
	•	Volume mounts:
	•	veen-config → /etc/veen (read-only)
	•	veen-keys → /etc/veen/keys (read-only)
	•	veen-data → /var/lib/veen (read-write PVC)

4.3 Authority hub config

ConfigMap veen-authority-config MUST provide:
	•	Hub listening address and port.
	•	Any local retention parameters for authority streams.
	•	A stable authority identifier.

The config file MUST be resolved relative to:
	•	/etc/veen/hub.yaml

Authority hub MUST not re-generate its identity at startup; it MUST always use keys from veen-authority-keys.

4.4 PVC behaviour
	•	PVC veen-authority-data MUST be bound to storage with:
	•	ReadWriteOnce access mode.
	•	Capacity sufficient for authority metadata and revocation history.
	•	StatefulSet MUST not mount emptyDir for /var/lib/veen.

Deleting the StatefulSet MUST NOT delete the PVC by default; PVC lifecycle is managed explicitly.
	5.	Tenant hub specification

5.1 Resource set

For each tenant namespace veen-tenant-<tenant-id>:
	•	Deployment: veen-hub
	•	Service: veen-hub
	•	ConfigMap: veen-hub-config
	•	Secret: veen-hub-keys
	•	Optional PVC: veen-hub-data (if persistence is desired)

5.2 Tenant hub Deployment
	•	Replicas: 1 (v0.0.1++ does not define multi-replica hubs).
	•	Pod template:
	•	Image: veen-hub:<version>
	•	Command:
	•	veen-hub
	•	Arguments:
	•	--profile=tenant
	•	--config=/etc/veen/hub.yaml
	•	--data-dir=/var/lib/veen
	•	Env:
	•	VEEN_ROLE=tenant
	•	VEEN_TENANT_ID=<tenant-id>
	•	VEEN_UNIVERSE_ID=<universe-id>
	•	Volumes:
	•	ConfigMap veen-hub-config → /etc/veen (read-only).
	•	Secret veen-hub-keys → /etc/veen/keys (read-only).
	•	One of:
	•	emptyDir volume veen-data → /var/lib/veen (disposable).
	•	PVC veen-hub-data → /var/lib/veen (persistent).

5.3 Tenant hub config

ConfigMap veen-hub-config MUST encode:
	•	authority_url
	•	URL of the authority hub Service:
	•	http://veen-authority.veen-system.svc.cluster.local:8080
	•	hub_profile
	•	tenant
	•	retention
	•	Optional: retention hints for non-critical streams.
	•	Any per-tenant policy parameters (for example, WAL size, attachment limits).

5.4 Tenant hub lifetime
	•	Creating the namespace and applying the manifests MUST be sufficient to bring the hub to a ready state.
	•	Deleting the namespace MUST remove:
	•	Deployment
	•	Service
	•	ConfigMap
	•	Secrets
	•	All emptyDir volumes
	•	If a PVC exists, its deletion policy SHOULD be explicit:
	•	For fully disposable tenants: PVC created in the same namespace and removed with it.
	•	For “archived tenants”: PVC may be in another namespace or bound to a static volume; this is outside v0.0.1++.

	6.	Bridge specification

6.1 Resource set

Bridge processes MAY be long-running or one-off.

Per universe or per tenant, the following resources are typical:
	•	Deployment or Job: veen-bridge-<name>
	•	ConfigMap: veen-bridge-<name>-config
	•	Secret: veen-bridge-<name>-keys (optional)

6.2 Bridge container behaviour

Container image:
	•	veen-bridge:<version>

Command:
	•	veen-bridge

Arguments:
	•	--source-url=<hub-url>
	•	--target-url=<hub-url>
	•	--streams=<selector>
	•	For example core/*, wallet/*, or a specific stream id.

Environment:
	•	VEEN_ROLE=bridge
	•	Optionally VEEN_TENANT_ID when bound to a single tenant.

6.3 Bridge placement
	•	Authority→tenant bridges MAY run in:
	•	veen-system namespace, or
	•	the corresponding tenant namespace.
	•	Tenant↔tenant bridges SHOULD run in one of the tenant namespaces or in veen-system, but MUST be associated with tenants via labels and annotations.

6.4 Idempotency

Bridge implementation MUST ensure:
	•	Applying the same configuration twice MUST NOT create duplicate messages.
	•	Replaying from a checkpoint MUST NOT break message ordering or proofs.

	7.	CLI and Job usage

7.1 CLI container

Image:
	•	veen-cli:<version>

Command/args (examples):
	•	veen-cli keygen --out /work/client
	•	veen-cli cap issue --issuer /work/admin --subject /work/client --stream core/quota --ttl 600 --rate 100,100 --out /work/cap.cbor
	•	veen-cli stream --hub http://veen-hub:8080 --client /work/client --stream core/main --from 0

The CLI image MUST contain:
	•	veen-cli binary
	•	Optionally helper scripts for common operations

7.2 CLI Job pattern

Typical one-off workflow in a tenant namespace:
	•	Job name: veen-cli-<action>
	•	Pod container:
	•	Image: veen-cli:<version>
	•	Volume work as emptyDir for intermediate files.
	•	Secrets with keystores mounted read-only under /secrets.
	•	Command that:
	•	copies keystores from Secrets to /work
	•	runs veen-cli with /work paths
	•	writes any output artifacts into /work or logs.

7.3 External CLI

When cluster exposes a hub via Ingress:
	•	External operator MAY run veen-cli locally using:
	•	--hub pointing at the Ingress URL.
	•	In this case, keystores are managed locally and never enter the cluster.

	8.	Self-test integration

8.1 Core self-test Job per tenant

Each tenant namespace MUST provide a standard Job:
	•	Name: veen-selftest-core
	•	Container image: veen-selftest:<version>
	•	Command:
	•	veen-selftest core --hub http://veen-hub:8080
	•	Env:
	•	VEEN_ROLE=selftest
	•	VEEN_TENANT_ID=<tenant-id>
	•	Volumes:
	•	emptyDir for working directory
	•	Secrets containing any pre-generated test keys

The Job MUST exit with:
	•	code 0 when all invariants are satisfied
	•	non-zero code when any invariant fails

8.2 Authority self-test

In veen-system:
	•	Job: veen-selftest-authority
	•	Command:
	•	veen-selftest authority --hub http://veen-authority:8080

8.3 When to run self-tests

Self-tests SHOULD be run:
	•	immediately after deploying a new VEEN version in the cluster
	•	after changing authority config
	•	periodically via a CronJob for early detection of drift

	9.	Security, RBAC, and network policy

9.1 Minimal RBAC roles

A veen-operator ClusterRole SHOULD be defined with permissions to:
	•	Namespaces:
	•	get, list, create, delete for namespaces matching veen-*
	•	In VEEN namespaces:
	•	Deployments, StatefulSets, Jobs, Pods, Services, ConfigMaps, Secrets:
	•	get, list, watch, create, update, delete

Application roles in tenant namespaces MUST NOT have permission to:
	•	modify veen-hub Deployment
	•	modify veen-hub-config ConfigMap
	•	modify veen-hub-keys Secret

9.2 NetworkPolicy

For each tenant namespace:
	•	A NetworkPolicy SHOULD restrict inbound traffic to veen-hub Pods to:
	•	Pods with label veen.io/role=bridge
	•	Pods with label veen.io/role=selftest
	•	Application Pods explicitly allowed via label selectors.

Authority namespace SHOULD have similar NetworkPolicy restricting access to:
	•	authority hub
	•	any authority-level bridge or admin workloads

9.3 Secret handling
	•	Hub key Secrets MUST be created once and only referenced by Pods.
	•	Self-test and CLI Jobs MUST mount Secrets as read-only.
	•	Jobs MAY generate temporary keys into emptyDir volumes but MUST NOT write back into Secrets.

	10.	Health, readiness, and metrics

10.1 Health endpoints

Each hub MUST expose:
	•	/healthz
	•	returns success if process is alive
	•	MUST NOT perform expensive checks
	•	/readyz
	•	returns success when:
	•	local state directory is accessible
	•	required indexes are initialized
	•	authority hub (for tenants) is reachable or has a fresh view

Kubernetes Probes:
	•	LivenessProbe:
	•	HTTP GET /healthz.
	•	ReadinessProbe:
	•	HTTP GET /readyz.

10.2 Metrics

Each hub SHOULD expose:
	•	/metrics endpoint with counters and histograms including:
	•	message append count per stream
	•	append latency distribution
	•	checkpoint creation rate
	•	capability validation success/failure counts
	•	revocation view update lag
	•	WAL/attachment store usage metrics (bytes, count)

10.3 Logging

All VEEN containers MUST log to stdout/stderr with structured fields:
	•	ts (timestamp)
	•	level (info, warn, error)
	•	component (hub, bridge, cli, selftest)
	•	role (authority, tenant, bridge, selftest)
	•	Optional:
	•	tenant_id
	•	stream_id
	•	client_id
	•	operation

	11.	End-to-end lifecycle flows

11.1 Creating a new tenant network

Sequence:
	1.	Create namespace veen-tenant-<tenant-id>.
	2.	Create veen-hub-keys Secret with tenant hub key material.
	3.	Create veen-hub-config ConfigMap pointing at authority hub.
	4.	Create veen-hub Deployment and veen-hub Service.
	5.	Optionally create bridge Deployment or Job to sync authority streams.
	6.	Run veen-selftest-core Job and verify completion.

Completion condition:
	•	veen-hub Pod Ready
	•	self-test Job succeeded

11.2 Destroying a tenant network

Sequence:
	1.	Delete namespace veen-tenant-<tenant-id>.

Outcome:
	•	All tenant hub state is removed (including emptyDir volumes).
	•	Any per-tenant PVCs are removed if they were in the namespace.

11.3 Upgrading VEEN version

Per universe:
	1.	Update image tags in:
	•	veen-authority-hub StatefulSet
	•	veen-hub Deployments (all tenants)
	•	veen-bridge Deployments or Jobs
	•	veen-cli and veen-selftest Jobs
	2.	Apply updated manifests.
	3.	Wait for:
	•	authority hub pod Ready
	•	tenant hub pods Ready
	4.	Run:
	•	veen-selftest-authority in veen-system
	•	veen-selftest-core in each tenant namespace (or a representative subset)

11.4 Rotating hub keys

To rotate a tenant hub’s keys:
	1.	Generate new keys via CLI Job or external CLI.
	2.	Create a new Secret veen-hub-keys-next with new keys.
	3.	Update veen-hub Deployment to mount veen-hub-keys-next instead of current.
	4.	Apply Deployment and wait for pod restart and readiness.
	5.	Optionally revoke old keys at authority level using veen-cli revoke publish.

	12.	Profile constraints and compatibility

12.1 Protocol compatibility
	•	v0.0.1++ is strictly an operational profile.
	•	All VEEN binary formats (wire messages, proofs, identities, wallet state) remain as in v0.0.1.
	•	Any implementation claiming v0.0.1++ compatibility MUST:
	•	pass existing v0.0.1 tests
	•	pass self-tests when deployed under Kubernetes according to this profile

12.2 Structural invariants

The following invariants MUST hold:
	•	Exactly one veen-authority-hub StatefulSet in veen-system.
	•	Exactly one veen-authority Service in veen-system.
	•	At most one veen-hub Deployment per tenant namespace.
	•	Each hub Pod has a unique veen.io/universe-id and role.
	•	Self-test Jobs MUST be able to reach the hub Service via its internal DNS name.
	•	Deleting a tenant namespace MUST NOT affect the authority hub or other tenants.

	13.	Implementation notes (non-normative)

	•	This profile is compatible with both full Kubernetes and k3s as long as:
	•	StatefulSet, Deployment, Service, ConfigMap, Secret, Job are supported.
	•	Operators are free to use Helm, Kustomize, or plain manifests as long as the resulting resources obey this spec.
	•	Higher-level constructs such as CRDs (VEENTenant, VEENUniverse) can wrap this profile but MUST not weaken its invariants.
